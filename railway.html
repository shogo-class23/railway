<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ねりか区営地下鉄 - 総合案内</title>
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #1abc9c;
            --danger: #e74c3c;
            --bg: #f4f7f6;
        }

        body { font-family: sans-serif; background-color: var(--bg); margin: 0; padding: 0; color: #333; }
        
        #portalScreen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
        }
        .company-card {
            background: rgba(255,255,255,0.1);
            border: 2px solid rgba(255,255,255,0.2);
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        .company-card:hover { background: var(--secondary); transform: translateY(-5px); border-color: white; }

        #mainApp { display: none; }
        header { background: var(--primary); color: white; text-align: center; padding: 15px; position: relative; }
        .back-btn { position: absolute; left: 15px; top: 15px; background: none; border: 1px solid white; color: white; padding: 5px 10px; cursor: pointer; border-radius: 4px; font-size: 0.8rem; }

        nav { background: #34495e; text-align: center; position: sticky; top: 0; z-index: 1000; }
        nav button { background: none; border: none; color: white; padding: 15px 20px; cursor: pointer; font-size: 0.9rem; }
        nav button.active { background: var(--secondary); }

        .container { max-width: 800px; margin: 20px auto; padding: 0 15px; }
        .page { display: none; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .page.active { display: block; }

        h2 { border-bottom: 3px solid var(--secondary); padding-bottom: 5px; color: var(--primary); }

        .search-form { background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px; }
        .input-row { margin-bottom: 15px; }
        .input-row label { display: block; font-size: 0.8rem; font-weight: bold; margin-bottom: 5px; }
        .radio-group { display: flex; gap: 15px; margin-bottom: 15px; flex-wrap: wrap; }
        .radio-group label { display: flex !important; align-items: center; gap: 5px; cursor: pointer; font-weight: bold; font-size: 0.9rem; }
        .radio-group input { width: auto !important; margin: 0; }
        input[type="text"], select { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; }
        .btn-search { background: var(--secondary); color: white; border: none; padding: 15px; width: 100%; border-radius: 6px; font-size: 1.1rem; font-weight: bold; cursor: pointer; }

        .route-result-item { margin-bottom: 40px; border-bottom: 2px dashed #eee; padding-bottom: 20px; }
        .route-result-item:last-child { border-bottom: none; }
        .route-header { background: #ecf0f1; padding: 10px 15px; border-radius: 6px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; }
        .route-tag-id { background: var(--primary); color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.8rem; margin-right: 10px; }
        
        .spec-tag { display: inline-block; padding: 2px 6px; border-radius: 4px; font-size: 0.75rem; font-weight: bold; color: white; margin-left: 5px; }
        .tag-fast { background: #e74c3c; }
        .tag-cheap { background: #f39c12; }
        .tag-easy { background: #3498db; }

        .route-box { border: 2px solid #eee; border-radius: 12px; padding: 20px; background: #fff; }
        .res-time-main { font-size: 1.4rem; font-weight: bold; color: var(--primary); margin-bottom: 5px; display: block; }
        
        .vertical-station-list { padding-left: 35px; border-left: 3px solid #eee; margin-left: 15px; margin-top: 15px; }
        .station-item { display: block; position: relative; margin-bottom: 25px; }
        .station-item::before { content: ''; position: absolute; left: -42.5px; top: 8px; width: 14px; height: 14px; background: white; border: 3px solid #ccc; border-radius: 50%; z-index: 10; }
        
        .line-badge { 
            display: inline-block; 
            color: white; 
            padding: 2px 10px; 
            border-radius: 4px; 
            font-size: 1rem; 
            font-weight: bold; 
            margin-left: 15px;
            vertical-align: middle;
        }
        .line-badge.東西線 { background: #2ecc71; }
        .line-badge.南北線 { background: #3498db; }
        .line-badge.空港線 { background: #f39c12; }
        .line-badge.都市線 { background: #9b59b6; }
        .line-badge.新線 { background: #e84393; }
        .line-badge.他社線 { background: #95a5a6; }
        .line-badge.海岸線 { background: #00cec9; }
        .line-badge.北部線 { background: #3498db; }
        .line-badge.上野線 { background: #e67e22; }
        .line-badge.京浜日本本線 { background: #c0392b; }
        .line-badge.芋窪線 { background: #27ae60; }
        .line-badge.静岡線 { background: #1e3799; }
        .line-badge.東海空港線 { background: #4a69bd; }
        .line-badge.愛知線 { background: #e84118; }
        .line-badge.名安線 { background: #f0932b; }
        .line-badge.桜通線 { background: #EA3223; }
        .line-badge.神丹線 { background: #0984e3; }
        .line-badge.東平野線 { background: #00b894; }
        .line-badge.播磨線 { background: #a52a2a; }
        .line-badge.新潟線 { background: #0fbcf9; }
        .line-badge.中山道急幹線 { background: #d4af37; }
        .line-badge.中部縦貫急幹線 { background: #d4af37; }
        .line-badge.金沢支線 { background: #d4af37; }
        .line-badge.西九州急幹線 { background: #d4af37; }
        .line-badge.山手線 { background: #2ecc71; }
        .line-badge.中央線 { background: #e67e22; }
        .line-badge.東海道本線 { background: #f39c12; }
        .line-badge.山陽・九州新幹線 { background: #3498db; }
        .line-badge.姫新線 { background: #f1c40f; }
        .line-badge.上越新幹線 { background: #2ecc71; }
        .line-badge.名鉄線 { background: #e84118; }
        .line-badge.天竜浜名湖鉄道 { background: #27ae60; }
        .line-badge.大井川鉄道 { background: #d35400; }

        .station-info-row { display: flex; align-items: center; }
        .station-name-text { display: block; font-size: 1.3rem; font-weight: bold; color: #000; }
        .role-tag { display: block; font-size: 0.85rem; font-weight: bold; margin-bottom: 4px; color: #7f8c8d; }

        .boarding-station::before { border-color: #2ecc71; background: #2ecc71; }
        .via-station::before { border-color: #f1c40f; background: #f1c40f; }
        .alighting-station::before { border-color: #e74c3c; background: #e74c3c; }

        .time-info-text { font-size: 1rem; color: #333; font-weight: bold; min-width: 60px; display: inline-block; }
        
        /* 1本前・1本後ボタン */
        .time-shift-buttons { display: flex; gap: 10px; margin-top: 20px; padding: 0 10px; }
        .btn-shift { flex: 1; background: #ecf0f1; border: 1px solid #bdc3c7; padding: 12px; border-radius: 6px; cursor: pointer; font-weight: bold; color: #2c3e50; }
        .btn-shift:hover { background: #bdc3c7; }

        .route-map-svg { width: 100%; height: auto; min-width: 650px; }

        /* 切符モーダルのスタイル */
        #ticketModal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 2000;
        }
        .ticket {
            background: #f1e4bc; color: #5d4037; padding: 30px; border-radius: 4px;
            width: 300px; box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            font-family: sans-serif;
            position: relative; border: 2px solid #d7ccc8;
            background-image: radial-gradient(circle at 0 50%, transparent 10px, #f1e4bc 11px), radial-gradient(circle at 100% 50%, transparent 10px, #f1e4bc 11px);
        }
        .ticket::after {
            content: ''; position: absolute; left: 10px; right: 10px; top: 50%;
            border-bottom: 2px dashed #d7ccc8;
        }
        .ticket-header { font-size: 0.8rem; border-bottom: 1px solid #5d4037; padding-bottom: 5px; margin-bottom: 10px; }
        .ticket-main { text-align: center; margin: 20px 0; }
        .ticket-st { font-size: 1.4rem; font-weight: bold; }
        .ticket-price { font-size: 1.2rem; margin-top: 5px; }
        .ticket-footer { font-size: 0.7rem; margin-top: 30px; text-align: right; }
        .btn-close-ticket {
            display: block; width: 100%; margin-top: 20px; padding: 10px;
            background: #5d4037; color: white; border: none; border-radius: 4px; cursor: pointer;
        }
    </style>
</head>
<body>

<div id="disclaimer" style="background: #fff3cd; color: #856404; text-align: center; padding: 5px; font-size: 0.8rem; border-bottom: 1px solid #ffeeba; position: relative; z-index: 3000;">
    ※このサイトに登場する鉄道、駅名、運行情報はすべて架空のものです。実在の人物・団体等とは一切関係ありません。
</div>

<div id="portalScreen">
    <div style="display: flex; gap: 20px; flex-wrap: wrap; justify-content: center; padding: 20px;">
        <div class="company-card" style="border-color: #3498db;" onclick="selectCompany('keihin')">
            <h1>京浜日本鉄道</h1>
            <p>北部・上野・本線・芋窪線</p>
            <small>クリックして入場</small>
        </div>
        <div class="company-card" style="border-color: #e67e22;" onclick="selectCompany('chiba')">
            <h1>千葉日本鉄道</h1>
            <p>千葉・取手線 総合案内</p>
            <small>クリックして入場</small>
        </div>
        <div class="company-card" style="border-color: #2ecc71;" onclick="selectCompany('motegi')">
            <h1>茂木日本鉄道</h1>
            <p>茂木線 総合案内</p>
            <small>クリックして入場</small>
        </div>
        <div class="company-card" style="border-color: #1e3799;" onclick="selectCompany('tokai')">
            <h1>東海日本鉄道</h1>
            <p>静岡・愛知・名安・各自社線 総合案内</p>
            <small>クリックして入場</small>
        </div>
        <div class="company-card" style="border-color: #27ae60;" onclick="selectCompany('private_railways')">
            <h1>私鉄線</h1>
            <p>名鉄・天浜・大井川線 総合案内</p>
            <small>クリックして入場</small>
        </div>
        <div class="company-card" style="border-color: #0984e3;" onclick="selectCompany('kansai')">
            <h1>関西日本鉄道</h1>
            <p>神丹線・東平野線・播磨線 総合案内</p>
            <small>クリックして入場</small>
        </div>
        <div class="company-card" style="border-color: #0fbcf9;" onclick="selectCompany('hokuriku')">
            <h1>北陸日本鉄道</h1>
            <p>新潟線 総合案内</p>
            <small>クリックして入場</small>
        </div>
        <div class="company-card" style="border-color: #d4af37;" onclick="selectCompany('kyukansen')">
            <h1>日本急幹線</h1>
            <p>中山道・中部縦貫・西九州急幹線 総合案内</p>
            <small>クリックして入場</small>
        </div>
        <div class="company-card" style="border-color: #2ecc71;" onclick="selectCompany('jr_lines')">
            <h1 style="color: #2ecc71;">JR線</h1>
            <p>山手・中央・新幹線・姫新・各線 総合案内</p>
            <small>実在路線のデモ接続</small>
        </div>
        <div class="company-card" style="border-color: #2c3e50; background: #fff; color: #2c3e50;" onclick="selectCompany('all')">
            <h1 style="color: #2c3e50;">全路線 総合案内</h1>
            <p>日本全国 ネットワーク検索</p>
            <small>(ねりか区営地下鉄を除く全社)</small>
        </div>
        <!-- 開発用サンプル -->
        <div class="company-card" style="border-color: #7f8c8d; opacity: 0.6; transform: scale(0.9);" onclick="selectCompany('nerika')">
            <h1 style="font-size: 1.2rem; color: #ccc;">ねりか区営地下鉄</h1>
            <p style="font-size: 0.8rem;">(開発用サンプル)</p>
            <small>東西・南北・空港・都市・新線・海岸線</small>
        </div>
    </div>
</div>

<div id="mainApp">
    <header>
        <button class="back-btn" onclick="location.reload()">◀ 会社選択へ</button>
        <h1 id="appTitle">案内システム</h1>
    </header>
    <nav id="topNav">
        <button id="btn-status" onclick="showPage('status')" class="active">運行情報</button>
        <button id="btn-routeMap" onclick="showPage('routeMap')">路線図</button>
        <button id="btn-stopMap" onclick="showPage('stopMap')">停車駅</button>
        <button id="btn-transfer" onclick="showPage('transfer')">乗換案内</button>
    </nav>
    <div class="container">
        <section id="status" class="page active"><h2>運行情報</h2><div id="statusList"></div></section>
        <section id="routeMap" class="page">
            <h2>路線図</h2>
            <div id="mapContainer" style="overflow-x:auto; background: white; padding: 10px; border-radius: 12px; border: 1px solid #eee;"></div>
            <div id="mapLegend" style="margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap; justify-content: center;"></div>
        </section>
        <section id="stopMap" class="page"><h2>停車駅路線図</h2><div id="stopMapContainer"></div></section>
        <section id="transfer" class="page">
            <h2>乗換案内</h2>
            <div class="search-form">
                <div class="input-row"><label>出発駅</label><input type="text" id="fromSt" placeholder="例: 奥駅" list="stationList"></div>
                <div class="input-row"><label>経由駅</label><input type="text" id="viaSt" placeholder="任意" list="stationList"></div>
                <div class="input-row"><label>降りる駅</label><input type="text" id="toSt" placeholder="例: 發駅" list="stationList"></div>
                <datalist id="stationList"></datalist>
                <div class="input-row" style="display:flex; gap:10px; align-items:center;">
                    <select id="hSel" style="width:70px;"></select>時 <select id="mSel" style="width:70px;"></select>分
                </div>
                <div class="radio-group">
                    <label><input type="radio" name="stype" value="出発" checked>出発</label>
                    <label><input type="radio" name="stype" value="到着">到着</label>
                    <label><input type="radio" name="stype" value="始発">始発</label>
                    <label><input type="radio" name="stype" value="終電">終電</label>
                </div>
                <button class="btn-search" onclick="search()">ルートを検索</button>
                <div class="time-shift-buttons" style="margin-top: 10px;">
                    <button class="btn-shift" onclick="shiftTime(-15)">1本前</button>
                    <button class="btn-shift" onclick="shiftTime(15)">1本後</button>
                </div>
            </div>
            <div id="transferResults"></div>
        </section>
    </div>
</div>

<script>
    const companies = {
        nerika: {
            name: "ねりか区営地下鉄",
            routes: {
                "東西線": { stations: ["奥駅", "西駅", "本駅", "中央駅", "東駅"], interval: 3 },
                "南北線": { stations: ["北駅", "新駅", "中央駅", "市駅", "南駅"], interval: 3 },
                "空港線": { stations: ["空港駅", "丸台駅", "上駅", "中央駅", "公園前駅", "下駅", "大学前駅", "口駅"], interval: 3 },
                "都市線": { 
                    stations: ["空港駅", "車庫駅", "北駅", "丸ヶ丘駅", "白駅", "中央駅", "市駅", "發駅"], 
                    intervals: [5, 5, 3, 3, 3, 3, 3],
                    services: [
                        { name: "各駅停車", stops: ["空港駅", "車庫駅", "北駅", "丸ヶ丘駅", "白駅", "中央駅", "市駅", "發駅"], offset: 0 },
                        { name: "準急", stops: ["空港駅", "車庫駅", "北駅", "白駅", "中央駅", "市駅", "發駅"], offset: 3 },
                        { name: "快速", stops: ["空港駅", "北駅", "丸ヶ丘駅", "中央駅", "發駅"], offset: 7 },
                        { name: "急行", stops: ["空港駅", "北駅", "中央駅", "發駅"], offset: 12 },
                        { name: "特急", stops: ["空港駅", "中央駅", "發駅"], specific: [14, 44] }
                    ]
                },
                "新線": { stations: ["發駅", "南駅", "南西駅", "下駅", "西前駅", "本駅", "白駅", "新駅", "上駅", "東駅", "東南駅", "区役所前駅", "發駅"], interval: 3 },
                "他社線": { stations: ["中央駅", "白駅", "北東駅", "ドーム前駅"], interval: 2 },
                "海岸線": { stations: ["ドーム前駅", "隣町駅", "川駅", "海岸駅"], interval: 2 }
            },
            status: ["東西線: 平常", "南北線: 平常", "空港線: 平常", "都市線: 平常", "新線: 平常", "海岸線: 平常"],
            svg: `<svg class="route-map-svg" viewBox="0 0 800 550">
                <circle cx="450" cy="300" r="200" fill="none" stroke="#e84393" stroke-width="8" opacity="0.4" />
                <text x="650" y="520" fill="#e84393" font-size="20" font-weight="bold" text-anchor="middle">新線</text>
                <line x1="50" y1="200" x2="623" y2="200" stroke="#2ecc71" stroke-width="10" />
                <text x="50" y="170" fill="#27ae60" font-size="18" font-weight="bold">東西線</text>
                <line x1="446" y1="50" x2="446" y2="500" stroke="#3498db" stroke-width="8" />
                <text x="465" y="75" fill="#2980b9" font-size="18" font-weight="bold">南北線</text>
                <path d="M750 50 L570 140 L450 200 L350 250 L250 300 L100 375" fill="none" stroke="#f39c12" stroke-width="8" opacity="0.8" />
                <text x="100" y="340" fill="#d35400" font-size="18" font-weight="bold">空港線</text>
                <path d="M750 50 L454 50 L350 127 L454 200 L454 400 L550 473" fill="none" stroke="#9b59b6" stroke-width="8" opacity="0.7" />
                <text x="650" y="30" fill="#8e44ad" font-size="18" font-weight="bold" text-anchor="end">都市線</text>
                <path d="M455 205 L355 132 L310 105 L270 85" fill="none" stroke="#95a5a6" stroke-width="3" opacity="0.8" />
                <text x="310" y="60" fill="#7f8c8d" font-size="15" font-weight="bold" transform="rotate(-35, 310, 60)">他社線</text>
                <path d="M270 85 L210 85 L150 85 L90 85" fill="none" stroke="#00cec9" stroke-width="8" opacity="0.8" />
                <text x="120" y="110" fill="#00b894" font-size="15" font-weight="bold">海岸線</text>
                <circle cx="446" cy="100" r="8" fill="white" stroke="#3498db" stroke-width="2.5" /><text x="458" y="95" font-size="14" font-weight="bold">新駅</text>
                <circle cx="570" cy="140" r="10" fill="white" stroke="#333" stroke-width="3" /><text x="585" y="145" font-size="15" font-weight="bold">上駅</text>
                <circle cx="623" cy="200" r="8" fill="white" stroke="#2ecc71" stroke-width="2.5" /><text x="635" y="195" font-size="14" font-weight="bold">東駅</text>
                <circle cx="650" cy="300" r="8" fill="white" stroke="#e84393" stroke-width="2.5" /><text x="665" y="305" font-size="14" font-weight="bold">東南駅</text>
                <circle cx="623" cy="400" r="8" fill="white" stroke="#e84393" stroke-width="2.5" /><text x="635" y="415" font-size="14" font-weight="bold">区役所前駅</text>
                <circle cx="550" cy="473" r="8" fill="white" stroke="#e84393" stroke-width="2.5" /><text x="560" y="500" font-size="14" font-weight="bold">發駅</text>
                <circle cx="446" cy="500" r="8" fill="white" stroke="#3498db" stroke-width="2.5" /><text x="458" y="530" font-size="14" font-weight="bold">南駅</text>
                <circle cx="350" cy="473" r="8" fill="white" stroke="#e84393" stroke-width="2.5" /><text x="280" y="500" font-size="14" font-weight="bold" text-anchor="end">南西駅</text>
                <circle cx="250" cy="300" r="10" fill="white" stroke="#333" stroke-width="3" /><text x="235" y="325" font-size="15" font-weight="bold" text-anchor="end">下駅</text>
                <circle cx="259" cy="240" r="8" fill="white" stroke="#e84393" stroke-width="2.5" /><text x="245" y="240" font-size="14" font-weight="bold" text-anchor="end">西前駅</text>
                <circle cx="277" cy="200" r="8" fill="white" stroke="#2ecc71" stroke-width="2.5" /><text x="277" y="180" font-size="14" font-weight="bold" text-anchor="middle">本駅</text>
                <circle cx="350" cy="127" r="8" fill="white" stroke="#9b59b6" stroke-width="2.5" /><text x="340" y="115" font-size="14" font-weight="bold" text-anchor="end">白駅</text>
                <circle cx="450" cy="200" r="12" fill="white" stroke="#333" stroke-width="4" /><text x="465" y="225" font-size="18" font-weight="bold">中央駅</text>
                <circle cx="450" cy="400" r="10" fill="white" stroke="#333" stroke-width="3" /><text x="465" y="415" font-size="15" font-weight="bold">市駅</text>
                <circle cx="450" cy="50" r="8" fill="white" stroke="#3498db" stroke-width="2.5" /><text x="450" y="35" font-size="14" font-weight="bold" text-anchor="middle">北駅</text>
                <circle cx="400" cy="88" r="6" fill="white" stroke="#9b59b6" stroke-width="1.5" /><text x="390" y="80" font-size="12" font-weight="bold" text-anchor="end">丸ヶ丘駅</text>
                <circle cx="50" cy="200" r="8" fill="white" stroke="#2ecc71" stroke-width="2.5" /><text x="50" y="235" font-size="14" font-weight="bold" text-anchor="middle">奥駅</text>
                <circle cx="120" cy="200" r="8" fill="white" stroke="#2ecc71" stroke-width="2.5" /><text x="120" y="235" font-size="14" font-weight="bold" text-anchor="middle">西駅</text>
                <circle cx="750" cy="50" r="8" fill="white" stroke="#f39c12" stroke-width="2.5" /><text x="750" y="35" font-size="14" font-weight="bold" text-anchor="middle">空港駅</text>
                <circle cx="350" cy="250" r="8" fill="white" stroke="#f39c12" stroke-width="2.5" /><text x="365" y="255" font-size="14" font-weight="bold">公園前駅</text>
                <circle cx="100" cy="375" r="8" fill="white" stroke="#f39c12" stroke-width="2.5" /><text x="100" y="405" font-size="14" font-weight="bold" text-anchor="middle">口駅</text>
                <circle cx="650" cy="100" r="6" fill="white" stroke="#f39c12" stroke-width="1.5" /><text x="660" y="100" font-size="12" font-weight="bold">丸台駅</text>
                <circle cx="175" cy="337.5" r="10" fill="white" stroke="#f39c12" stroke-width="3" /><text x="185" y="365" font-size="15" font-weight="bold">大学前駅</text>
                <circle cx="600" cy="50" r="6" fill="white" stroke="#9b59b6" stroke-width="1.5" /><text x="600" y="35" font-size="12" font-weight="bold" text-anchor="middle">車庫駅</text>
                <circle cx="310" cy="105" r="8" fill="white" stroke="#95a5a6" stroke-width="2.5" /><text x="310" y="90" font-size="12" font-weight="bold" text-anchor="middle">北東駅</text>
                <circle cx="270" cy="85" r="10" fill="white" stroke="#333" stroke-width="3" /><text x="270" y="65" font-size="14" font-weight="bold" text-anchor="middle">ドーム前駅</text>
                <circle cx="210" cy="85" r="8" fill="white" stroke="#00cec9" stroke-width="2.5" /><text x="210" y="65" font-size="12" font-weight="bold" text-anchor="middle">隣町駅</text>
                <circle cx="150" cy="85" r="8" fill="white" stroke="#00cec9" stroke-width="2.5" /><text x="150" y="65" font-size="12" font-weight="bold" text-anchor="middle">川駅</text>
                <circle cx="90" cy="85" r="8" fill="white" stroke="#00cec9" stroke-width="2.5" /><text x="90" y="65" font-size="12" font-weight="bold" text-anchor="middle">海岸駅</text>
                </svg>`
        },
        keihin: {
            name: "京浜日本鉄道",
            routes: {
                "北部線": { 
                    stations: ["光が丘", "田柄", "平和台", "新練馬", "中央公園", "新ときわ台", "板橋本町", "東十条", "新神谷", "鹿浜", "江北", "大師", "西新井", "足立", "加平", "北綾瀬", "大谷田", "亀有", "金町"],
                    interval: 3 
                },
                "上野線": {
                    stations: ["池袋", "上池袋", "西巣鴨", "王子", "堀船", "江北", "大師", "西新井", "足立", "梅田", "北千住", "千住大橋", "南千住", "浅草", "北上野", "上野"],
                    interval: 3
                },
                "京浜日本本線": {
                    stations: ["大宮", "西与野", "与野公園", "桜浦和", "町谷", "西浦和", "西戸田", "美女木", "笹目", "南戸田", "西高島平", "徳丸", "新赤塚", "平和台", "練馬春日町", "谷原", "練馬高野台", "南田中", "井荻", "桃井", "荻窪", "宮前", "高井戸", "南高井戸", "八幡山", "希望丘", "千歳船橋", "砧", "新用賀", "瀬田", "上野毛", "下野毛", "宮内", "南等々力", "武蔵小杉", "沼部", "御嶽山", "久が原", "西馬込", "南久が原", "徳持", "幸", "川崎口", "鶴見川", "三ッ池公園", "獅子ヶ谷", "新大倉山", "新横浜", "三枚町", "三ツ沢公園", "横浜"],
                    interval: 2
                },
                "芋窪線": {
                    stations: ["西武球場前", "芋窪", "上北台"],
                    interval: 3
                }
            },
            status: ["北部線: 平常", "上野線: 平常", "京浜日本本線: 平常", "芋窪線: 平常"],
            svg: `<svg class="route-map-svg" viewBox="0 0 1100 1800">
                <!-- 京浜日本本線 (Red) -->
                <line x1="500" y1="50" x2="500" y2="1750" stroke="#c0392b" stroke-width="12" opacity="0.8" />
                <text x="525" y="70" fill="#c0392b" font-size="24" font-weight="bold">京浜日本本線</text>

                <!-- 北部線 (Blue) -->
                <line x1="50" y1="500" x2="1050" y2="500" stroke="#3498db" stroke-width="12" />
                <text x="50" y="460" fill="#2980b9" font-size="20" font-weight="bold">北部線</text>
                
                <!-- 上野線 (Orange) -->
                <path d="M250 800 L250 650 L350 550 L500 525 L650 500 L850 500 L850 850" fill="none" stroke="#e67e22" stroke-width="10" opacity="0.8" />
                <text x="880" y="860" fill="#d35400" font-size="20" font-weight="bold">上野線</text>

                <!-- 芋窪線 (Green) -->
                <line x1="100" y1="650" x2="100" y2="850" stroke="#27ae60" stroke-width="8" opacity="0.8" />
                <text x="80" y="630" fill="#27ae60" font-size="18" font-weight="bold">芋窪線</text>

                <!-- 本線の駅 (間隔を32pxに拡大) -->
                ${["大宮", "西与野", "与野公園", "桜浦和", "町谷", "西浦和", "西戸田", "美女木", "笹目", "南戸田", "西高島平", "徳丸", "新赤塚", "平和台", "練馬春日町", "谷原", "練馬高野台", "南田中", "井荻", "桃井", "荻窪", "宮前", "高井戸", "南高井戸", "八幡山", "希望丘", "千歳船橋", "砧", "新用賀", "瀬田", "上野毛", "下野毛", "宮内", "南等々力", "武蔵小杉", "沼部", "御嶽山", "久が原", "西馬込", "南久が原", "徳持", "幸", "川崎口", "鶴見川", "三ッ池公園", "獅子ヶ谷", "新大倉山", "新横浜", "三枚町", "三ツ沢公園", "横浜"].map((st, i) => {
                    const y = 50 + i * 34;
                    return `
                        <circle cx="500" cy="${y}" r="7" fill="white" stroke="#c0392b" stroke-width="2.5" />
                        <text x="${i % 2 === 0 ? 515 : 485}" y="${y + 5}" font-size="12" font-weight="bold" text-anchor="${i % 2 === 0 ? 'start' : 'end'}">${st}</text>
                    `;
                }).join('')}

                <!-- 北部線の駅 (間隔を広げ、平和台を本線に合わせる) -->
                ${["光が丘", "田柄", "平和台", "新練馬", "中央公園", "新ときわ台", "板橋本町", "東十条", "新神谷", "鹿浜", "江北", "大師", "西新井", "足立", "加平", "北綾瀬", "大谷田", "亀有", "金町"].map((st, i) => {
                    const x = 50 + i * 55;
                    const y = 500;
                    if (st === "平和台") return ''; 
                    return `
                        <circle cx="${x}" cy="${y}" r="8" fill="white" stroke="#333" stroke-width="3" />
                        <text x="${x}" y="${y - 20}" font-size="12" font-weight="bold" text-anchor="start" transform="rotate(-45, ${x}, ${y - 20})">${st}</text>
                    `;
                }).join('')}

                <!-- 芋窪線の駅 -->
                ${[
                    {name: "西武球場前", x: 100, y: 650}, {name: "芋窪", x: 100, y: 750}, {name: "上北台", x: 100, y: 850}
                ].map(st => `
                    <circle cx="${st.x}" cy="${st.y}" r="8" fill="white" stroke="#27ae60" stroke-width="3" />
                    <text x="${st.x + 20}" y="${st.y + 8}" font-size="14" font-weight="bold">${st.name}</text>
                `).join('')}

                <!-- 上野線の駅 -->
                ${[
                    {name: "池袋", x: 250, y: 800}, {name: "上池袋", x: 250, y: 760}, {name: "西巣鴨", x: 250, y: 720}, {name: "王子", x: 350, y: 550}, {name: "堀船", x: 500, y: 525},
                    {name: "梅田", x: 850, y: 550}, {name: "北千住", x: 850, y: 600}, {name: "千住大橋", x: 850, y: 650}, {name: "南千住", x: 850, y: 700}, {name: "浅草", x: 850, y: 750}, {name: "北上野", x: 850, y: 800}, {name: "上野", x: 850, y: 850}
                ].map(st => `
                    <circle cx="${st.x}" cy="${st.y}" r="7" fill="white" stroke="#e67e22" stroke-width="2.5" />
                    <text x="${st.x + 15}" y="${st.y + 5}" font-size="12" font-weight="bold" text-anchor="start">${st.name}</text>
                `).join('')}
            </svg>`
        },
        chiba: {
            name: "千葉日本鉄道",
            routes: {
                "千葉日本線": {
                    stations: ["千葉", "長沼", "新勝田台", "米本", "小室", "取手"],
                    interval: 15,
                    unit_dur: 5
                }
            },
            status: ["千葉日本線: 平常"],
            svg: `<svg class="route-map-svg" viewBox="0 0 400 600">
                <line x1="200" y1="100" x2="200" y2="500" stroke="#e67e22" stroke-width="12" />
                <text x="230" y="80" fill="#d35400" font-size="22" font-weight="bold">千葉日本線</text>
                ${["千葉", "長沼", "新勝田台", "米本", "小室", "取手"].reverse().map((st, i) => `
                    <circle cx="200" cy="${100 + i * 80}" r="10" fill="white" stroke="#333" stroke-width="3" />
                    <text x="230" y="${105 + i * 80}" font-size="16" font-weight="bold">${st}</text>
                `).join('')}
            </svg>`
        },
        motegi: {
            name: "茂木日本鉄道",
            routes: {
                "茂木日本線": {
                    stations: ["芳賀町工業団地管理センター前", "下高根沢", "祖母井", "上根", "市貝", "新天矢場", "茂木"],
                    interval: 4
                }
            },
            status: ["茂木日本線: 平常"],
            svg: `<svg class="route-map-svg" viewBox="0 0 1000 350">
                <line x1="100" y1="150" x2="880" y2="150" stroke="#2ecc71" stroke-width="12" />
                <text x="50" y="100" fill="#27ae60" font-size="24" font-weight="bold">茂木日本線</text>
                ${["芳賀町工業団地管理センター前", "下高根沢", "祖母井", "上根", "市貝", "新天矢場", "茂木"].map((st, i) => `
                    <circle cx="${100 + i * 130}" cy="150" r="10" fill="white" stroke="#333" stroke-width="3" />
                    <text x="${100 + i * 130}" y="${i % 2 === 0 ? 200 : 230}" font-size="13" text-anchor="middle" font-weight="bold">${st}</text>
                `).join('')}
            </svg>`
        },
        tokai: {
            name: "東海日本鉄道",
            routes: {
                "静岡線": {
                    stations: ["掛川", "金谷", "満水", "西方", "北菊川", "富田"],
                    interval: 10
                },
                "東海空港線": {
                    stations: ["富田", "牧之原", "静岡空港"],
                    interval: 15
                },
                "愛知線": {
                    stations: ["新所原", "東二川", "二川", "山田町", "豊橋", "豊川", "新小坂井", "新小田渕", "国府", "御油", "赤坂", "南長沢", "北蒲郡", "中蒲郡", "蒲郡"],
                    interval: 15
                },
                "名安線": {
                    stations: ["新安城", "新牛田", "知立北", "一里山", "北刈谷", "井ケ谷", "沓掛", "東鳴海", "徳重"],
                    interval: 15
                },
                "桜通線": {
                    stations: ["徳重", "神沢", "相生山", "鳴子北", "野並", "鶴里", "桜本町", "新瑞橋", "瑞穂運動場西", "瑞穂区役所", "桜山", "御器所", "吹上", "今池", "車道", "高岳", "久屋大通", "丸の内", "国際センター", "名古屋", "太閤通"],
                    interval: 10
                }
            },
            status: ["東海日本鉄道: 平常"],
            svg: `<svg class="route-map-svg" viewBox="0 0 1400 800">
                <!-- 静岡線・空港線 -->
                <line x1="1000" y1="50" x2="1300" y2="50" stroke="#1e3799" stroke-width="8" />
                <line x1="1300" y1="50" x2="1300" y2="150" stroke="#4a69bd" stroke-width="6" />
                ${["掛川", "金谷", "満水", "西方", "北菊川", "富田"].map((st, i) => `<circle cx="${1000 + i * 75}" cy="50" r="8" fill="white" stroke="#1e3799" stroke-width="3" /><text x="${1000 + i * 75}" y="${i%2===0?85:105}" font-size="15" text-anchor="middle" font-weight="bold">${st}</text>`).join('')}
                ${["牧之原", "静岡空港"].map((st, i) => `<circle cx="1300" cy="${80 + i * 40}" r="8" fill="white" stroke="#4a69bd" stroke-width="3" /><text x="1315" y="${85 + i * 40}" font-size="15" font-weight="bold">${st}</text>`).join('')}

                <!-- 愛知線 -->
                <path d="M1300 300 L600 300" fill="none" stroke="#e84118" stroke-width="10" />
                <text x="1300" y="270" fill="#e84118" font-size="22" font-weight="bold" text-anchor="end">愛知線</text>
                ${["新所原", "東二川", "二川", "山田町", "豊橋", "豊川", "新小坂井", "新小田渕", "国府", "御油", "赤坂", "南長沢", "北蒲郡", "中蒲郡", "蒲郡"].reverse().map((st, i) => `
                    <circle cx="${600 + i * 50}" cy="300" r="9" fill="white" stroke="#333" stroke-width="3" />
                    <text x="${600 + i * 50}" y="${i % 2 === 0 ? 345 : 380}" font-size="13" text-anchor="middle" font-weight="bold" transform="rotate(-30, ${600 + i * 50}, ${i % 2 === 0 ? 345 : 380})">${st}</text>
                `).join('')}

                <!-- 名安線 (蒲郡との間を空ける) -->
                <path d="M538 300 L50 300" fill="none" stroke="#f0932b" stroke-width="10" />
                <text x="50" y="270" fill="#f0932b" font-size="22" font-weight="bold">名安線</text>
                ${["新安城", "新牛田", "知立北", "一里山", "北刈谷", "井ケ谷", "沓掛", "東鳴海", "徳重"].reverse().map((st, i) => {
                    const x = 50 + i * 61;
                    return `
                        <circle cx="${x}" cy="300" r="9" fill="white" stroke="#333" stroke-width="3" />
                        <text x="${x}" y="${i % 2 === 0 ? 345 : 380}" font-size="13" text-anchor="middle" font-weight="bold" transform="rotate(-30, ${x}, ${i % 2 === 0 ? 345 : 380})">${st}</text>
                    `;
                }).join('')}

                <!-- 桜通線 (他社線) -->
                <path d="M50 300 L50 550 L875 550" fill="none" stroke="#EA3223" stroke-width="3" opacity="0.6" />
                <text x="875" y="520" fill="#EA3223" font-size="20" font-weight="bold" text-anchor="end">名古屋市営地下鉄 桜通線</text>
                ${["徳重", "神沢", "相生山", "鳴子北", "野並", "鶴里", "桜本町", "新瑞橋", "瑞穂運動場西", "瑞穂区役所", "桜山", "御器所", "吹上", "今池", "車道", "高岳", "久屋大通", "丸の内", "国際センター", "名古屋", "太閤通"].map((st, i) => {
                    let x, y, dx = 15, dy = 5;
                    if (i === 0) { x = 50; y = 300; } // 徳重
                    else if (i < 6) { x = 50; y = 300 + i * 40; } // 垂直区間
                    else { 
                        x = 50 + (i - 5) * 55; y = 550; dx = 0; dy = 45; // 線の下に統一して配置
                    }
                    return `
                        <circle cx="${x}" cy="${y}" r="6" fill="white" stroke="#EA3223" stroke-width="2" />
                        <text x="${x + dx}" y="${y + dy}" font-size="12" font-weight="bold" text-anchor="start" transform="${i >= 6 ? 'rotate(35, '+x+', '+(y+dy)+')' : ''}">${st}</text>
                    `;
                }).join('')}
            </svg>`
        },
        private_railways: {
            name: "私鉄線",
            routes: {
                "名鉄線": {
                    stations: ["新安城", "蒲郡"],
                    interval: 15,
                    unit_dur: 67
                },
                "天竜浜名湖鉄道": {
                    stations: ["新所原", "掛川"],
                    interval: 30,
                    unit_dur: 130
                },
                "大井川鉄道": {
                    stations: ["金谷", "千頭"],
                    interval: 60,
                    unit_dur: 90
                }
            },
            status: ["私鉄各線: 平常"],
            svg: `<p style="text-align:center; padding:20px;">私鉄路線の図面は準備中です。</p>`
        },
        kansai: {
            name: "関西日本鉄道",
            routes: {
                "神丹線": {
                    stations: ["神戸三宮", "新神戸", "春日野", "摩耶", "長峰", "六甲", "渦森", "柏堂", "甲陽園北", "上ヶ原", "甲東園口", "北武庫", "山田", "伊丹市", "北伊丹", "南池田", "大阪空港", "新豊中", "中豊中", "南豊中", "上津島", "庄本", "大豊橋", "加島", "田川", "野中", "新大阪", "中島", "豊崎", "大阪梅田"],
                    interval: 5
                },
                "東平野線": {
                    stations: ["南梅田", "南森町", "京橋", "森ノ宮新", "東森ノ宮", "玉造", "今里", "大池橋", "北巽", "南巽", "平野北", "平野南", "西瓜破", "東松原", "大堀"],
                    interval: 5
                },
                "播磨線": {
                    stations: ["佐用", "宍粟山崎", "夢前", "新福崎", "北条町"],
                    interval: 15,
                    unit_dur: 10
                }
            },
            status: ["神丹線: 平常", "東平野線: 平常", "播磨線: 平常"],
            svg: `<svg class="route-map-svg" viewBox="0 0 1600 900">
                <!-- 神丹線 -->
                <path d="M50 150 L1500 150" fill="none" stroke="#0984e3" stroke-width="10" />
                <text x="50" y="120" fill="#0984e3" font-size="24" font-weight="bold">神丹線</text>
                ${["神戸三宮", "新神戸", "春日野", "摩耶", "長峰", "六甲", "渦森", "柏堂", "甲陽園北", "上ヶ原", "甲東園口", "北武庫", "山田", "伊丹市", "北伊丹", "南池田", "大阪空港", "新豊中", "中豊中", "南豊中", "上津島", "庄本", "大豊橋", "加島", "田川", "野中", "新大阪", "中島", "豊崎", "大阪梅田"].map((st, i) => `
                    <circle cx="${50 + i * 50}" cy="150" r="${st==='大阪梅田'?12:8}" fill="white" stroke="#333" stroke-width="3" />
                    <text x="${50 + i * 50}" y="${i % 2 === 0 ? 195 : 220}" font-size="13" text-anchor="middle" font-weight="bold" transform="rotate(-30, ${50 + i * 50}, ${i % 2 === 0 ? 195 : 220})">${st}</text>
                `).join('')}

                <!-- 東平野線 -->
                <path d="M1500 250 L1500 810" fill="none" stroke="#00b894" stroke-width="10" />
                <text x="1480" y="810" fill="#00b894" font-size="24" font-weight="bold" text-anchor="end">東平野線</text>
                ${["南梅田", "南森町", "京橋", "森ノ宮新", "東森ノ宮", "玉造", "今里", "大池橋", "北巽", "南巽", "平野北", "平野南", "西瓜破", "東松原", "大堀"].map((st, i) => `
                    <circle cx="1500" cy="${250 + i * 40}" r="${st==='南梅田'?12:8}" fill="white" stroke="#333" stroke-width="3" />
                    <text x="1520" y="${255 + i * 40}" font-size="14" font-weight="bold">${st}</text>
                `).join('')}
                
                <!-- 播磨線 -->
                <path d="M50 500 L770 500" fill="none" stroke="#a52a2a" stroke-width="8" />
                <text x="50" y="470" fill="#a52a2a" font-size="22" font-weight="bold">播磨線</text>
                ${["佐用", "宍粟山崎", "夢前", "新福崎", "北条町"].map((st, i) => `
                    <circle cx="${50 + i * 180}" cy="500" r="10" fill="white" stroke="#333" stroke-width="3" />
                    <text x="${50 + i * 180}" y="${i%2===0?545:570}" font-size="16" text-anchor="middle" font-weight="bold">${st}</text>
                `).join('')}

                <!-- 接続イメージ（梅田エリア） -->
                <rect x="1450" y="130" width="100" height="150" fill="rgba(0,0,0,0.05)" stroke="#ccc" stroke-dasharray="4" />
                <text x="1440" y="300" font-size="16" font-weight="bold" fill="#666" text-anchor="end">梅田エリア乗換</text>
            </svg>`
        },
        jr_lines: {
            name: "JR線",
            routes: {
                "山手線": {
                    stations: ["上野", "日暮里", "田端", "池袋", "新宿", "渋谷", "品川", "東京", "秋葉原", "上野"],
                    interval: 5
                },
                "中央線": {
                    stations: ["東京", "神田", "御茶ノ水", "四ツ谷", "新宿", "中野", "荻窪", "吉祥寺", "三鷹", "国分寺", "立川", "八王子"],
                    interval: 5
                },
                "東海道本線": {
                    stations: ["東京", "品川", "川崎", "横浜", "大船", "藤沢", "茅ヶ崎", "平塚", "小田原", "熱海"],
                    interval: 10
                },
                "山陽・九州新幹線": {
                    stations: ["姫路", "小倉", "熊本", "出水"],
                    interval: 30,
                    intervals: [118, 50, 32]
                },
                "姫新線": {
                    stations: ["姫路", "佐用"],
                    interval: 60,
                    intervals: [36]
                },
                "上越新幹線": {
                    stations: ["長岡", "新潟"],
                    interval: 40,
                    intervals: [22]
                }
            },
            status: ["山手線: 平常", "中央線: 平常", "東海道本線: 平常", "新幹線: 平常"],
            svg: `<svg class="route-map-svg" viewBox="0 0 600 600">
                <circle cx="300" cy="300" r="200" fill="none" stroke="#2ecc71" stroke-width="10" />      
                <text x="300" y="80" fill="#27ae60" font-size="24" font-weight="bold" text-anchor="middle">山手線</text>
                <line x1="300" y1="300" x2="100" y2="300" stroke="#e67e22" stroke-width="10" />
                <text x="120" y="280" fill="#d35400" font-size="20" font-weight="bold">中央線</text>
                <line x1="300" y1="500" x2="300" y2="580" stroke="#f39c12" stroke-width="10" />
                <text x="320" y="560" fill="#d35400" font-size="20" font-weight="bold">東海道本線</text>
                ${[
                    {name:"東京", x:473, y:400}, {name:"品川", x:300, y:500}, {name:"新宿", x:100, y:300}, {name:"池袋", x:127, y:200}, {name:"上野", x:300, y:100}
                ].map(st => `<circle cx="${st.x}" cy="${st.y}" r="10" fill="white" stroke="#333" stroke-width="3" /><text x="${st.x+15}" y="${st.y+5}" font-size="14" font-weight="bold">${st.name}</text>`).join('')}
            </svg>`
        },
        hokuriku: {
            name: "北陸日本鉄道",
            routes: {
                "新潟線": {
                    stations: ["新潟", "万代", "沼垂", "新潟港", "物見山", "新潟空港", "松浜", "福祉大", "島見", "内島見", "藤寄", "黒山"],
                    interval: 10
                }
            },
            status: ["新潟線: 平常"],
            svg: `<svg class="route-map-svg" viewBox="0 0 1000 300">
                <line x1="50" y1="150" x2="950" y2="150" stroke="#0fbcf9" stroke-width="10" />
                <text x="50" y="110" fill="#0fbcf9" font-size="24" font-weight="bold">新潟線</text>
                ${["新潟", "万代", "沼垂", "新潟港", "物見山", "新潟空港", "松浜", "福祉大", "島見", "内島見", "藤寄", "黒山"].map((st, i) => `
                    <circle cx="${50 + i * 82}" cy="150" r="10" fill="white" stroke="#333" stroke-width="3" />
                    <text x="${50 + i * 82}" y="${i % 2 === 0 ? 200 : 230}" font-size="15" text-anchor="middle" font-weight="bold" transform="rotate(-20, ${50 + i * 82}, ${i % 2 === 0 ? 200 : 230})">${st}</text>
                `).join('')}
            </svg>`
        },
        kyukansen: {
            name: "日本急幹線",
            routes: {
                "中山道急幹線": {
                    stations: ["新大阪", "松井山手", "宇治田原", "伊賀甲賀", "急幹四日市", "急幹長島", "急幹弥富", "金城ふ頭", "名古屋", "急幹岐阜", "郡上八幡", "高山", "平湯", "松本", "佐久平", "下仁田", "秩父", "大宮"],
                    interval: 15,
                    unit_dur: 30
                },
                "中部縦貫急幹線": {
                    stations: ["仙台", "秋保温泉", "山形", "西米沢", "喜多方", "長岡", "柏崎", "上越妙高", "長野", "松本", "飯田市", "千頭", "静岡"],
                    interval: 15,
                    unit_dur: 30
                },
                "金沢支線": {
                    stations: ["高山", "白川", "福光", "金沢"],
                    interval: 15,
                    unit_dur: 30
                },
                "西九州急幹線": {
                    stations: ["熊本", "島原", "口之津", "天草空港", "長島", "出水"],
                    interval: 15,
                    unit_dur: 30
                }
            },
            status: ["中山道急幹線: 平常", "中部縦貫急幹線: 平常", "金沢支線: 平常", "西九州急幹線: 平常"],
            svg: `<svg class="route-map-svg" viewBox="0 0 1600 1200">
                <!-- 中山道急幹線 (水平) -->
                <line x1="50" y1="600" x2="1550" y2="600" stroke="#d4af37" stroke-width="12" opacity="0.8" />
                <text x="50" y="540" fill="#d4af37" font-size="32" font-weight="bold">中山道急幹線</text>
                ${["新大阪", "松井山手", "宇治田原", "伊賀甲賀", "急幹四日市", "急幹長島", "急幹弥富", "金城ふ頭", "名古屋", "急幹岐阜", "郡上八幡", "高山", "平湯", "松本", "佐久平", "下仁田", "秩父", "大宮"].map((st, i) => {
                    const x = 50 + i * 88;
                    const y = 600;
                    const isBelow = (i < 11 ? i % 2 === 0 : i % 2 !== 0);
                    const textY = isBelow ? y + 50 : y - 35;
                    return `
                        <circle cx="${x}" cy="${y}" r="${(st==='松本'||st==='高山')?16:10}" fill="white" stroke="#333" stroke-width="4" />
                        <text x="${x}" y="${textY}" font-size="15" text-anchor="middle" font-weight="bold" transform="rotate(-30, ${x}, ${textY})">${st}</text>
                    `;
                }).join('')}

                <!-- 金沢支線 (垂直) -->
                <line x1="1018" y1="600" x2="1018" y2="360" stroke="#d4af37" stroke-width="12" opacity="0.8" />
                <text x="1040" y="340" fill="#d4af37" font-size="28" font-weight="bold">金沢支線</text>
                ${["高山", "白川", "福光", "金沢"].map((st, i) => {
                    if (st === "高山") return '';
                    const x = 1018;
                    const y = 600 - i * 80;
                    return `
                        <circle cx="${x}" cy="${y}" r="10" fill="white" stroke="#333" stroke-width="4" />
                        <text x="${x + 25}" y="${y + 8}" font-size="16" font-weight="bold" text-anchor="start">${st}</text>
                    `;
                }).join('')}

                <!-- 西九州急幹線 (左下水平) -->
                <line x1="50" y1="1000" x2="650" y2="1000" stroke="#d4af37" stroke-width="12" opacity="0.8" />
                <text x="50" y="940" fill="#d4af37" font-size="32" font-weight="bold">西九州急幹線</text>
                ${["熊本", "島原", "口之津", "天草空港", "長島", "出水"].map((st, i) => {
                    const x = 50 + i * 120;
                    const y = 1000;
                    return `
                        <circle cx="${x}" cy="${y}" r="10" fill="white" stroke="#333" stroke-width="4" />
                        <text x="${x}" y="${y + 50}" font-size="15" text-anchor="middle" font-weight="bold" transform="rotate(-30, ${x}, ${y + 50})">${st}</text>
                    `;
                }).join('')}

                <!-- 中部縦貫急幹線 (仙台〜長岡は水平、長岡〜静岡は垂直) -->
                <path d="M1550 150 L1194 150 L1194 1100" fill="none" stroke="#d4af37" stroke-width="12" stroke-linejoin="round" />
                <text x="1550" y="110" fill="#d4af37" font-size="32" font-weight="bold" text-anchor="end">中部縦貫急幹線</text>
                
                <!-- 仙台〜長岡 (水平区間) -->
                ${["仙台", "秋保温泉", "山形", "西米沢", "喜多方", "長岡"].reverse().map((st, i) => {
                    const x = 1194 + i * 71.2; 
                    const y = 150;
                    return `
                        <circle cx="${x}" cy="${y}" r="10" fill="white" stroke="#333" stroke-width="4" />
                        <text x="${x}" y="${y - 25}" font-size="16" text-anchor="middle" font-weight="bold">${st}</text>
                    `;
                }).join('')}

                <!-- 長岡〜静岡 (垂直区間) -->
                ${["長岡", "柏崎", "上越妙高", "長野", "松本", "飯田市", "千頭", "静岡"].map((st, i) => {
                    if (st === "長岡") return ''; 
                    const x = 1194;
                    let y;
                    if (i <= 4) y = 150 + i * 112.5; 
                    else y = 600 + (i - 4) * 166.6; 
                    if (st === "松本") y = 600; 
                    return `
                        <circle cx="${x}" cy="${y}" r="${st==='松本'?16:10}" fill="white" stroke="#333" stroke-width="4" />
                        <text x="${x + 25}" y="${y + 8}" font-size="16" font-weight="bold" text-anchor="start">${st}</text>
                    `;
                }).join('')}
            </svg>`
        }
    };

    let curComp = null;
    const hs = document.getElementById('hSel'), ms = document.getElementById('mSel');
    for(let i=0; i<24; i++) hs.innerHTML += `<option value="${i}">${i.toString().padStart(2,'0')}</option>`;
    for(let i=0; i<60; i++) ms.innerHTML += `<option value="${i}">${i.toString().padStart(2,'0')}</option>`;
    hs.value = 12;

    function selectCompany(id) {
        if (id === 'all') {
            curComp = {
                name: "全路線 総合案内 (ねりか除く)",
                routes: {},
                status: []
            };
            for (const [cid, cdata] of Object.entries(companies)) {
                if (cid === 'nerika') continue;
                Object.assign(curComp.routes, cdata.routes);
                curComp.status.push(...cdata.status);
            }
        } else {
            curComp = companies[id];
        }
        document.getElementById('portalScreen').style.display = 'none';
        document.getElementById('mainApp').style.display = 'block';
        document.getElementById('appTitle').innerText = curComp.name;
        document.getElementById('statusList').innerHTML = curComp.status.map(s => `<div style="padding:10px; border-left:5px solid var(--secondary); background:#f9f9f9; margin-bottom:5px;">${s}</div>`).join('');
        document.getElementById('mapContainer').innerHTML = curComp.svg || '<p style="text-align:center; padding:20px;">全路線図は個別の会社ページでご確認ください。</p>';
        
        // Generate Legend
        document.getElementById('mapLegend').innerHTML = Object.keys(curComp.routes).map(line => `<span class="line-badge ${line}">${line}</span>`).join('');

        const stSet = new Set();
        Object.values(curComp.routes).forEach(r => r.stations.forEach(s => stSet.add(s)));
        document.getElementById('stationList').innerHTML = Array.from(stSet).map(s => `<option value="${s}">`).join('');
        showPage('status');
    }

    function showPage(id) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        const target = document.getElementById(id);
        if (target) target.classList.add('active');
        
        document.querySelectorAll('#topNav button').forEach(b => b.classList.remove('active'));
        const btn = document.getElementById('btn-' + id);
        if (btn) btn.classList.add('active');
        
        if (id === 'stopMap') renderStopMap();
    }

    function renderStopMap() {
        let html = "";
        for (const [lineName, data] of Object.entries(curComp.routes)) {
            if (lineName === "他社線") continue;
            html += `<div style="margin-bottom:40px;"><h3>${lineName}</h3>`;
            if (lineName === "都市線") {
                const svcs = data.services;
                const stations = data.stations;
                const svcColors = { "各駅停車": "#7f8c8d", "準急": "#2ecc71", "快速": "#3498db", "急行": "#e67e22", "特急": "#e74c3c" };
                
                const width = stations.length * 100 + 150;
                const height = svcs.length * 40 + 60;
                let svg = `<svg width="${width}" height="${height}" viewBox="0 0 ${width} ${height}">`;
                
                // Station Vertical Lines and Names
                stations.forEach((st, i) => {
                    const x = i * 100 + 100;
                    svg += `<line x1="${x}" y1="35" x2="${x}" y2="${height - 20}" stroke="#eee" stroke-width="2" />`;
                    svg += `<text x="${x}" y="20" font-size="12" text-anchor="middle" font-weight="bold">${st}</text>`;
                });

                // Service Lines and Stop Circles
                svcs.forEach((svc, si) => {
                    const y = si * 40 + 45;
                    const color = svcColors[svc.name] || "#333";
                    svg += `<text x="5" y="${y + 5}" font-size="12" font-weight="bold" fill="${color}">${svc.name}</text>`;
                    
                    // Line spanning only from first to last stop
                    const firstIdx = stations.indexOf(svc.stops[0]);
                    const lastIdx = stations.indexOf(svc.stops[svc.stops.length - 1]);
                    svg += `<line x1="${firstIdx * 100 + 100}" y1="${y}" x2="${lastIdx * 100 + 100}" y2="${y}" stroke="${color}" stroke-width="4" />`;
                    
                    stations.forEach((st, i) => {
                        if (svc.stops.includes(st)) {
                            svg += `<circle cx="${i * 100 + 100}" cy="${y}" r="6" fill="white" stroke="${color}" stroke-width="3" />`;
                        }
                    });
                });
                svg += `</svg>`;
                html += `<div style="overflow-x:auto; background:white; padding:20px; border-radius:12px; border: 1px solid #eee;">${svg}</div>`;
            } else {
                html += `<div style="padding:15px; background:#f8f9fa; border-radius:10px; color:#666;">各駅停車のみ</div>`;
            }
            html += `</div>`;
        }
        document.getElementById('stopMapContainer').innerHTML = html;
    }

    function setRadio(v) { document.querySelectorAll('input[name="stype"]').forEach(r => r.checked = (r.value === v)); }

    function shiftTime(minutes) {
        const type = document.querySelector('input[name="stype"]:checked').value;
        if(type === "始発" && minutes < 0) { setRadio("終電"); }
        else if(type === "終電" && minutes > 0) { setRadio("始発"); }
        else if(type === "始発" || type === "終電") {
            setRadio("出発");
            let bh = (type==="始発")?4:1, bm = (type==="始発")?30:0;
            let tm = bh*60 + bm + minutes;
            hs.value = Math.floor(tm/60); ms.value = tm%60;
        } else {
            let total = parseInt(hs.value)*60 + parseInt(ms.value) + minutes;
            if(total<0) total += 1440; total %= 1440;
            hs.value = Math.floor(total/60); ms.value = total%60;
            if(hs.value == 4 && ms.value == 30) setRadio("始発");
            else if(hs.value == 1 && ms.value == 0) setRadio("終電");
        }
        search();
    }

    function calcD(data, s, e) {
        if (s === e) return 0;
        const n = data.stations.length;
        const isLoop = data.stations[0] === data.stations[n-1];
        if (data.intervals) {
            const min = Math.min(s, e), max = Math.max(s, e);
            return data.intervals.slice(min, max).reduce((a, b) => a + b, 0);
        }
        let d = Math.abs(s - e);
        if (isLoop) { d = Math.min(d, (n - 1) - d); }
        return d * (data.unit_dur || data.interval || 3);
    }

    function getMid(data, sIdx, eIdx, svcStops) {
        const st = svcStops || data.stations;
        const sName = data.stations[sIdx], eName = data.stations[eIdx];
        const s = st.indexOf(sName), e = st.indexOf(eName);
        if (s === -1 || e === -1 || s === e) return [];
        
        const res = [], n = st.length;
        const isLoop = st[0] === st[n-1], loopLen = n - 1;
        let diff = e - s, step = diff > 0 ? 1 : -1, dist = Math.abs(diff);
        if (isLoop && dist > loopLen / 2) { step = -step; dist = loopLen - dist; }
        
        let curr = s;
        for(let i = 1; i < dist; i++) {
            curr = (curr + step + (isLoop ? loopLen : 0)) % (isLoop ? loopLen : n);
            const name = st[curr];
            const currIdx = data.stations.indexOf(name);
            res.push({
                name: name, 
                type: "intermediate", 
                timeOffset: calcD(data, sIdx, currIdx)
            });
        }
        return res;
    }

    function getSnap(base, svc, durFromTerm, isArr) {
        // base: 検索目標時刻, durFromTerm: 始発駅(index 0)からその駅までの走行時間
        if (svc.specific) {
            let opts = [];
            for(let h=0; h<24; h++) svc.specific.forEach(m => opts.push(h*60 + m + durFromTerm));
            opts.sort((a, b) => a - b);
            if (isArr) {
                let last = -1;
                opts.forEach(o => { if (o <= base) last = o; });
                if (last === -1) last = opts[opts.length-1] - 1440;
                return last;
            } else {
                let first = 9999;
                opts.forEach(o => { if (o >= base) first = Math.min(first, o); });
                if (first === 9999) first = opts[0] + 1440;
                return first;
            }
        }
        const interval = svc.interval || 15, offset = (svc.offset || 0) + durFromTerm;
        if (isArr) return Math.floor((base - offset) / interval) * interval + offset;
        return Math.ceil((base - offset) / interval) * interval + offset;
    }

    function search() {
        const from = document.getElementById('fromSt').value, to = document.getElementById('toSt').value, via = document.getElementById('viaSt').value;
        if (!from || !to) return alert("駅名を入力してください");

        const getSvcs = (d) => d.services || [{ name: "各駅停車", stops: d.stations, offset: 0 }];
        const allRoutes = [];
        for (const [lineName, data] of Object.entries(curComp.routes)) {
            for (const svc of getSvcs(data)) {
                allRoutes.push({ lineName, data, svc });
            }
        }

        // 徒歩連絡
        const walkPairs = [["大阪梅田", "南梅田", 30]];

        // BFS-based search for multiple transfers
        let queue = [{
            currSt: from,
            dur: 0,
            transfers: 0,
            steps: [],
            visitedLines: new Set(),
            visitedStations: new Set([from])
        }];
        
        const possibleRoutes = [];
        const maxTransfers = 6; // Increase to 6 for long-distance across companies

        while (queue.length > 0) {
            const path = queue.shift();
            if (path.transfers > maxTransfers) continue;
            if (possibleRoutes.length >= 10 && path.dur > possibleRoutes[0].dur * 2) continue; // Pruning

            // Try all lines passing through current station
            for (const { lineName, data, svc } of allRoutes) {
                if (path.visitedLines.has(lineName)) continue;
                if (!svc.stops.includes(path.currSt)) continue;

                const fromIdx = data.stations.indexOf(path.currSt);
                
                // Optimized: only look for target or transfer points to other lines
                for (const targetSt of svc.stops) {
                    if (targetSt === path.currSt) continue;
                    if (path.visitedStations.has(targetSt)) continue;

                    const toIdx = data.stations.indexOf(targetSt);
                    const legDur = calcD(data, fromIdx, toIdx);
                    
                    const newSteps = [...path.steps];
                    if (newSteps.length > 0 && newSteps[newSteps.length - 1].type === "via-station") {
                        const prev = newSteps[newSteps.length - 1];
                        prev.lineName = `${svc.name} (${lineName})`;
                        prev.departureOffset = path.dur + 5;
                    }

                    const currentLegSteps = [
                        {
                            role: path.steps.length === 0 ? "boarding" : "transfer-info",
                            lineName: `${svc.name} (${lineName})`,
                            name: path.currSt,
                            type: path.steps.length === 0 ? "boarding-station" : "info-only",
                            timeOffset: path.dur
                        },
                        ...getMid(data, fromIdx, toIdx, svc.stops).map(s => ({...s, timeOffset: s.timeOffset + path.dur})),
                    ];

                    const totalDur = path.dur + legDur;
                    const finalSteps = [...newSteps, ...currentLegSteps];

                    if (targetSt === to) {
                        possibleRoutes.push({
                            dur: totalDur,
                            transfers: path.transfers,
                            svc: path.steps.length === 0 ? svc : path.firstSvc,
                            lastSvc: svc,
                            durFromTerm: path.steps.length === 0 ? calcD(data, 0, fromIdx) : path.firstDurFromTerm,
                            durToTerm: calcD(data, 0, toIdx),
                            steps: [...finalSteps, {role:"【降りる場所】", name:to, type:"alighting-station", timeOffset: totalDur}],
                            desc: path.transfers === 0 ? `${svc.name} 直通` : `${path.transfers}回乗換`
                        });
                        if (possibleRoutes.length > 20) break;
                    } else if (path.transfers < maxTransfers) {
                        // To speed up, we only transfer at stations that are on other lines or special hubs
                        const isTransferPoint = allRoutes.some(r => r.lineName !== lineName && r.svc.stops.includes(targetSt)) || 
                                              walkPairs.some(w => w[0] === targetSt || w[1] === targetSt);
                        
                        if (isTransferPoint) {
                            const nextVisitedLines = new Set(path.visitedLines);
                            nextVisitedLines.add(lineName);
                            const nextVisitedStations = new Set(path.visitedStations);
                            nextVisitedStations.add(targetSt);

                            queue.push({
                                currSt: targetSt,
                                dur: totalDur + 5, 
                                transfers: path.transfers + 1,
                                firstSvc: path.steps.length === 0 ? svc : path.firstSvc,
                                firstDurFromTerm: path.steps.length === 0 ? calcD(data, 0, fromIdx) : path.firstDurFromTerm,
                                steps: [...finalSteps, {
                                    role: "transfer",
                                    name: targetSt,
                                    type: "via-station",
                                    sub: "乗換 5分",
                                    arrivalOffset: totalDur,
                                    departureOffset: totalDur + 5
                                }],
                                visitedLines: nextVisitedLines,
                                visitedStations: nextVisitedStations
                            });
                        }
                    }
                }
            }

            // Handle walking transfers (Osaka Umeda - Minami Umeda)
            for (const [w1, w2, wDur] of walkPairs) {
                if (path.currSt === w1 || path.currSt === w2) {
                    const targetSt = (path.currSt === w1) ? w2 : w1;
                    if (path.visitedStations.has(targetSt)) continue;

                    const totalDur = path.dur + wDur;
                    const nextVisitedStations = new Set(path.visitedStations);
                    nextVisitedStations.add(targetSt);

                    queue.push({
                        currSt: targetSt,
                        dur: totalDur,
                        transfers: path.transfers, 
                        firstSvc: path.firstSvc,
                        firstDurFromTerm: path.firstDurFromTerm,
                        steps: [...path.steps, {
                            role: "transfer",
                            name: `${path.currSt}→${targetSt}`,
                            type: "via-station",
                            sub: `徒歩 ${wDur}分`,
                            arrivalOffset: path.dur,
                            departureOffset: totalDur
                        }],
                        visitedLines: new Set(path.visitedLines),
                        visitedStations: nextVisitedStations
                    });
                }
            }
            
            if (queue.length > 1000) queue = queue.slice(0, 1000);
            queue.sort((a, b) => a.dur - b.dur);
        }

        let results = possibleRoutes;
        if (via) { results = results.filter(r => r.steps.some(s => s.name === via)); }
        results = results.filter((v, i, a) => a.findIndex(t => t.dur === v.dur && JSON.stringify(t.steps) === JSON.stringify(v.steps)) === i);
        if (results.length === 0) { document.getElementById('transferResults').innerHTML = "<p>経路が見つかりませんでした。</p>"; return; }
        
        results.sort((a, b) => a.dur - b.dur);
        const minDur = results[0].dur, minTransfer = Math.min(...results.map(r => r.transfers));
        const minCost = Math.min(...results.map(r => Math.floor(100 + (r.dur/3)*50)));

        results = results.slice(0, 5); 
        const type = document.querySelector('input[name="stype"]:checked').value;
        const formatT = (m) => { while(m < 0) m += 1440; m %= 1440; return `${Math.floor(m/60).toString().padStart(2,'0')}:${(m%60).toString().padStart(2,'0')}`; };
        let base = parseInt(hs.value)*60 + parseInt(ms.value);

        let finalHtml = results.map((res, idx) => {
            let dm, am;
            if(type==="始発"){dm=getSnap(270,res.svc,res.durFromTerm,false); am=dm+res.dur;} 
            else if(type==="終電"){dm=getSnap(60,res.svc,res.durFromTerm,true); am=dm+res.dur;}
            else if(type==="到着"){
                let arrival_svc = res.lastSvc || res.tSvc || res.svc;
                let arrival_time = getSnap(base, arrival_svc, res.durToTerm, true);
                dm = arrival_time - res.dur;
                am = arrival_time;
            } 
            else {
                dm = getSnap(base, res.svc, res.durFromTerm, false);
                am = dm + res.dur;
            }
            
            const cost = Math.floor(100 + (res.dur/3)*50);
            let tags = "";
            if(res.dur === minDur) tags += `<span class="spec-tag tag-fast">早</span>`;
            if(res.transfers === minTransfer) tags += `<span class="spec-tag tag-easy">楽</span>`;
            if(cost === minCost) tags += `<span class="spec-tag tag-cheap">安</span>`;

            const stepHtml = res.steps.map(s => {
                let timeText = "";
                if (s.role === 'transfer') {
                    timeText = `<div style="display:flex; flex-direction:column; line-height:1.2;">
                        <span class="time-info-text" style="font-size:0.85rem;">${formatT(dm + s.arrivalOffset)} 着</span>
                        <span class="time-info-text" style="font-size:0.85rem;">${formatT(dm + s.departureOffset)} 発</span>
                    </div>`;
                } else {
                    timeText = `<span class="time-info-text">${formatT(dm + s.timeOffset)}</span>`;
                }

                if(s.type === "intermediate") {
                    return `
                        <div class="station-item" style="opacity:0.8; margin-bottom:10px;">
                            <div class="station-info-row">
                                ${timeText}
                                <span class="station-name-text" style="font-size:1.1rem; font-weight:normal;">${s.name}</span>
                            </div>
                        </div>`;
                }
                let lineClass = "";
                if (s.lineName) {
                    const match = s.lineName.match(/\(([^)]+)\)/);
                    lineClass = match ? match[1] : "";
                }
                let badge = s.lineName ? `<span class="line-badge ${lineClass}">${s.lineName}</span>` : '';
                return `
                    <div class="station-item ${s.type}">
                        <div class="role-tag">${s.role === 'boarding' ? '【乗車】' : s.role === 'transfer' ? '【乗換】' : s.role}</div>
                        <div class="station-info-row">${timeText}<span class="station-name-text">${s.name}</span>${badge}</div>
                        ${s.sub ? `<div class="time-info-text" style="margin-left:65px; color:#666;">${s.sub}</div>` : ''}
                    </div>`;
            }).join('');

            return `
                <div class="route-result-item">
                    <div class="route-header">
                        <span><span class="route-tag-id">経路 ${idx+1}</span><strong>${res.desc}</strong>${tags}</span>
                        <div style="display:flex; align-items:center; gap:10px;">
                            <span style="color:#2980b9; font-weight:bold;">${res.dur}分 / ${cost}円</span>
                            <button onclick="buyTicket('${from}', '${to}', ${cost})" style="background:var(--secondary); color:white; border:none; padding:5px 10px; border-radius:4px; font-size:0.8rem; cursor:pointer;">切符を買う</button>
                        </div>
                    </div>
                    <div class="route-box"><span class="res-time-main">${formatT(dm)} ～ ${formatT(am)}</span><div class="vertical-station-list">${stepHtml}</div></div>
                </div>
            `;
        }).join('');

        finalHtml += `<div class="time-shift-buttons"><button class="btn-shift" onclick="shiftTime(-15)">1本前</button><button class="btn-shift" onclick="shiftTime(15)">1本後</button></div>`;
        document.getElementById('transferResults').innerHTML = finalHtml;
    }

    function buyTicket(from, to, price) {
        const modal = document.createElement('div');
        modal.id = 'ticketModal';
        modal.innerHTML = `
            <div class="ticket">
                <div class="ticket-header">日本鉄道 旅客鉄道株式会社</div>
                <div class="ticket-main">
                    <div class="ticket-st">${from} から</div>
                    <div class="ticket-price">${to} まで</div>
                    <div style="font-size: 2rem; margin: 10px 0;">${price}円</div>
                </div>
                <div class="ticket-footer">${new Date().toLocaleDateString()} 発行</div>
                <button class="btn-close-ticket" onclick="document.body.removeChild(this.parentElement.parentElement)">閉じる</button>
            </div>
        `;
        document.body.appendChild(modal);
    }
</script>
</body>
</html>
