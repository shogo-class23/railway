<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>鉄道総合案内システム</title>
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #1abc9c;
            --danger: #e74c3c;
            --bg: #f4f7f6;
        }

        body { font-family: sans-serif; background-color: var(--bg); margin: 0; padding: 0; color: #333; }
        header { background: var(--primary); color: white; text-align: center; padding: 20px; }
        nav { background: #34495e; text-align: center; position: sticky; top: 0; z-index: 1000; }
        nav button { background: none; border: none; color: white; padding: 15px 20px; cursor: pointer; font-size: 0.9rem; }
        nav button.active { background: var(--secondary); }

        .container { max-width: 800px; margin: 20px auto; padding: 0 15px; }
        .page { display: none; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .page.active { display: block; }

        h2 { border-bottom: 3px solid var(--secondary); padding-bottom: 5px; color: var(--primary); }

        /* フォーム */
        .search-form { background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px; }
        .input-row { margin-bottom: 15px; }
        .input-row label { display: block; font-size: 0.8rem; font-weight: bold; margin-bottom: 5px; }
        input[type="text"], select { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; }
        .type-options { margin: 15px 0; }
        .type-options label { margin-right: 15px; font-weight: bold; cursor: pointer; }

        .btn-search { background: var(--secondary); color: white; border: none; padding: 15px; width: 100%; border-radius: 6px; font-size: 1.1rem; font-weight: bold; cursor: pointer; }

        /* 結果表示 */
        .time-shift-buttons { display: flex; gap: 10px; margin-top: 20px; }
        .btn-shift { flex: 1; background: #ecf0f1; border: 1px solid #bdc3c7; padding: 10px; border-radius: 6px; cursor: pointer; font-weight: bold; }

        .route-box { border: 2px solid #eee; border-radius: 12px; padding: 25px; margin-top: 30px; background: #fff; }
        .route-time-header { border-bottom: 2px solid #f0f0f0; padding-bottom: 12px; margin-bottom: 20px; }
        .time-range-text { font-size: 1.5rem; font-weight: bold; color: var(--primary); display: block; }

        .vertical-station-list { padding-left: 35px; border-left: 3px solid #eee; margin-left: 15px; margin-top: 20px; }
        .station-item { display: block !important; position: relative; margin-bottom: 30px; }
        .station-item::before { content: ''; position: absolute; left: -44px; top: 8px; width: 14px; height: 14px; background: white; border: 3px solid #ccc; border-radius: 50%; }

        .role-tag { display: block; font-size: 0.75rem; font-weight: bold; color: #888; margin-bottom: 4px; }
        .station-name-text { display: block; font-size: 1.25rem; font-weight: bold; color: #333; }
        .time-info-text { display: block; font-size: 0.9rem; color: #7f8c8d; margin-top: 5px; }

        .boarding-station::before { border-color: var(--secondary); background: var(--secondary); }
        .via-station .station-name-text { font-size: 1.1rem !important; color: #7f8c8d !important; }
        .alighting-station .station-name-text { font-size: 1.6rem !important; color: var(--danger) !important; font-weight: 900; }
        .alighting-station::before { width: 18px; height: 18px; left: -46px; top: 10px; background: var(--danger); border-color: var(--danger); }

        .route-info { margin-bottom: 15px; padding: 12px; background: #f8f9fa; border-radius: 8px; font-weight: bold; }

        /* 路線図 */
        .route-map-svg { width: 100%; height: auto; min-width: 600px; }
        
        table { width: 100%; border-collapse: collapse; }
        th, td { border: 1px solid #eee; padding: 12px; text-align: center; }
        th { background: var(--primary); color: white; }
    </style>
</head>
<body>

<header><h1>鉄道総合案内システム</h1></header>

<nav id="mainNav">
    <button onclick="showPage('status')" class="active">運行情報</button>
    <button onclick="showPage('routeMap')">路線図</button>
    <button onclick="showPage('transfer')">乗換案内</button>
</nav>

<div class="container">
    <section id="status" class="page active">
        <h2>運行情報</h2>
        <div style="padding:15px; border-left:8px solid var(--secondary); background:#f9f9f9; margin-bottom:10px;"><strong>東西線</strong>: 平常運転</div>
        <div style="padding:15px; border-left:8px solid #f1c40f; background:#f9f9f9; margin-bottom:10px;"><strong>南北線</strong>: 遅延 (約5分)</div>
        <div style="padding:15px; border-left:8px solid var(--secondary); background:#f9f9f9; margin-bottom:10px;"><strong>空港線</strong>: 平常運転</div>
        <div style="padding:15px; border-left:8px solid var(--secondary); background:#f9f9f9; margin-bottom:10px;"><strong>都市線</strong>: 平常運転</div>
    </section>

    <section id="routeMap" class="page">
        <h2>路線図</h2>
        <div style="overflow-x: auto; background: #fff; padding: 10px; border-radius: 8px;">
            <svg class="route-map-svg" viewBox="0 0 800 550">
                <!-- 東西線 (緑) -->
                <line x1="50" y1="250" x2="650" y2="250" stroke="#2ecc71" stroke-width="10" />
                <circle cx="50" cy="250" r="6" fill="white" stroke="#2ecc71" stroke-width="2" /><text x="35" y="280" font-size="12">奥駅</text>
                <circle cx="200" cy="250" r="6" fill="white" stroke="#2ecc71" stroke-width="2" /><text x="185" y="280" font-size="12">西駅</text>
                <circle cx="350" cy="250" r="6" fill="white" stroke="#2ecc71" stroke-width="2" /><text x="335" y="280" font-size="12">本駅</text>
                <circle cx="500" cy="250" r="10" fill="white" stroke="#333" stroke-width="4" /><text x="515" y="265" font-size="14" font-weight="bold">中央駅</text>
                <circle cx="650" cy="250" r="6" fill="white" stroke="#2ecc71" stroke-width="2" /><text x="635" y="280" font-size="12">東駅</text>

                <!-- 南北線 (青) - 少し左へずらす -->
                <line x1="496" y1="50" x2="496" y2="500" stroke="#3498db" stroke-width="8" />
                <circle cx="496" cy="50" r="6" fill="white" stroke="#3498db" stroke-width="2" /><text x="465" y="45" font-size="12" font-weight="bold">北駅</text>
                <circle cx="496" cy="150" r="6" fill="white" stroke="#3498db" stroke-width="2" /><text x="510" y="155" font-size="12">新駅</text>
                <circle cx="500" cy="380" r="8" fill="white" stroke="#333" stroke-width="3" /><text x="515" y="385" font-size="12" font-weight="bold">市駅</text>
                <circle cx="496" cy="500" r="6" fill="white" stroke="#3498db" stroke-width="2" /><text x="510" y="505" font-size="12">南駅</text>

                <!-- 空港線 (橙) -->
                <line x1="750" y1="50" x2="200" y2="500" stroke="#f39c12" stroke-width="8" opacity="0.8" />
                <circle cx="750" cy="50" r="6" fill="white" stroke="#f39c12" stroke-width="2" /><text x="710" y="45" font-size="12">空港駅</text>
                <circle cx="675" cy="105" r="6" fill="white" stroke="#f39c12" stroke-width="2" /><text x="685" y="110" font-size="12">丸台駅</text>
                <circle cx="600" cy="165" r="6" fill="white" stroke="#f39c12" stroke-width="2" /><text x="610" y="170" font-size="12">上駅</text>
                <circle cx="425" cy="315" r="6" fill="white" stroke="#f39c12" stroke-width="2" /><text x="360" y="320" font-size="12">公園前駅</text>
                <circle cx="350" cy="375" r="6" fill="white" stroke="#f39c12" stroke-width="2" /><text x="300" y="380" font-size="12">下駅</text>
                <circle cx="275" cy="435" r="6" fill="white" stroke="#f39c12" stroke-width="2" /><text x="210" y="440" font-size="12">大学前駅</text>
                <circle cx="200" cy="500" r="6" fill="white" stroke="#f39c12" stroke-width="2" /><text x="170" y="515" font-size="12">口駅</text>

                <!-- 都市線 (紫) - 南北線の右側を並行に、白-中央は斜め、市-發は右下へ -->
                <line x1="750" y1="50" x2="400" y2="50" stroke="#9b59b6" stroke-width="6" opacity="0.7" /> <!-- 空港-北 -->
                <line x1="400" y1="50" x2="400" y2="180" stroke="#9b59b6" stroke-width="6" opacity="0.7" /> <!-- 北-白 -->
                <line x1="400" y1="180" x2="504" y2="250" stroke="#9b59b6" stroke-width="6" opacity="0.7" /> <!-- 白-中央(斜め) -->
                <line x1="504" y1="250" x2="504" y2="380" stroke="#9b59b6" stroke-width="6" opacity="0.7" /> <!-- 中央-市(並行) -->
                <line x1="504" y1="380" x2="600" y2="480" stroke="#9b59b6" stroke-width="6" opacity="0.7" /> <!-- 市-發(右下) -->
                
                <circle cx="625" cy="50" r="5" fill="white" stroke="#9b59b6" stroke-width="2" /><text x="615" y="40" font-size="11">車庫駅</text>
                <circle cx="400" cy="100" r="5" fill="white" stroke="#9b59b6" stroke-width="2" /><text x="345" y="105" font-size="11">丸ヶ丘駅</text>
                <circle cx="400" cy="180" r="5" fill="white" stroke="#9b59b6" stroke-width="2" /><text x="365" y="185" font-size="11">白駅</text>
                <circle cx="600" cy="480" r="5" fill="white" stroke="#9b59b6" stroke-width="2" /><text x="615" y="485" font-size="11">發駅</text>
                
                <text x="20" y="245" font-size="10" fill="#2ecc71" font-weight="bold">東西線</text>
                <text x="490" y="40" font-size="10" fill="#3498db" font-weight="bold">南北線</text>
                <text x="760" y="75" font-size="10" fill="#f39c12" font-weight="bold">空港線</text>
                <text x="620" y="70" font-size="10" fill="#9b59b6" font-weight="bold">都市線</text>
            </svg>
        </div>
    </section>

    <section id="transfer" class="page">
        <h2>乗換案内</h2>
        <div class="search-form">
            <div class="input-row"><label>出発駅</label><input type="text" id="fromSt" placeholder="例: 空港駅" list="stationList"></div>
            <div class="input-row"><label>経由駅</label><input type="text" id="viaSt" placeholder="任意" list="stationList"></div>
            <div class="input-row"><label>降りる駅</label><input type="text" id="toSt" placeholder="例: 發駅" list="stationList"></div>
            <datalist id="stationList">
                <option value="奥駅"><option value="西駅"><option value="本駅"><option value="中央駅"><option value="東駅">
                <option value="北駅"><option value="新駅"><option value="市駅"><option value="南駅">
                <option value="空港駅"><option value="車庫駅"><option value="丸ヶ丘駅"><option value="白駅"><option value="發駅">
                <option value="丸台駅"><option value="上駅"><option value="公園前駅"><option value="下駅"><option value="大学前駅"><option value="口駅">
            </datalist>
            <div class="input-row" style="display:flex; gap:10px;">
                <select id="hSel" style="width:70px;"></select>時 <select id="mSel" style="width:70px;"></select>分
            </div>
            <div class="type-options">
                <label><input type="radio" name="stype" value="出発" checked>出発</label>
                <label><input type="radio" name="stype" value="到着">到着</label>
                <label><input type="radio" name="stype" value="始発">始発</label>
                <label><input type="radio" name="stype" value="終電">終電</label>
            </div>
            <button class="btn-search" onclick="search()">ルートを検索</button>
        </div>
        <div id="transferResults"></div>
    </section>
</div>

<script>
    const hs = document.getElementById('hSel');
    const ms = document.getElementById('mSel');
    for(let i=0; i<24; i++) hs.innerHTML += `<option value="${i}">${i.toString().padStart(2,'0')}</option>`;
    for(let i=0; i<60; i++) ms.innerHTML += `<option value="${i}">${i.toString().padStart(2,'0')}</option>`;
    hs.value = 12;

    const routes = {
        "東西線": { stations: ["奥駅", "西駅", "本駅", "中央駅", "東駅"], interval: 3 },
        "南北線": { stations: ["北駅", "新駅", "中央駅", "市駅", "南駅"], interval: 3 },
        "空港線": { stations: ["空港駅", "丸台駅", "上駅", "中央駅", "公園前駅", "下駅", "大学前駅", "口駅"], interval: 3 },
        "都市線": { stations: ["空港駅", "車庫駅", "北駅", "丸ヶ丘駅", "白駅", "中央駅", "市駅", "發駅"], intervals: [5, 5, 3, 3, 3, 3, 3] }
    };

    function showPage(id) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
        const btn = Array.from(document.querySelectorAll('nav button')).find(b => b.getAttribute('onclick').includes(id));
        if(btn) btn.classList.add('active');
    }

    function shiftTime(minutes) {
        let totalM = parseInt(hs.value) * 60 + parseInt(ms.value) + minutes;
        if (totalM < 0) totalM += 24 * 60;
        if (totalM >= 24 * 60) totalM -= 24 * 60;
        hs.value = Math.floor(totalM / 60);
        ms.value = totalM % 60;
        search();
    }

    function getStationInfo(name) {
        for (const [line, data] of Object.entries(routes)) {
            const index = data.stations.indexOf(name);
            if (index !== -1) return { line, index, data };
        }
        return null;
    }

    function calculateLineDuration(data, startIdx, endIdx) {
        if (data.intervals) {
            const min = Math.min(startIdx, endIdx);
            const max = Math.max(startIdx, endIdx);
            return data.intervals.slice(min, max).reduce((a, b) => a + b, 0);
        }
        return Math.abs(startIdx - endIdx) * (data.interval || 3);
    }

    function search() {
        const from = document.getElementById('fromSt').value;
        const via = document.getElementById('viaSt').value;
        const to = document.getElementById('toSt').value;
        const inputT = `${hs.value.padStart(2,'0')}:${ms.value.padStart(2,'0')}`;
        const type = document.querySelector('input[name="stype"]:checked').value;

        if(!from || !to) return alert('駅名を入力してください');

        const fromInfo = getStationInfo(from);
        const toInfo = getStationInfo(to);
        let duration = 0, steps = [];

        if (fromInfo && toInfo) {
            if (!via && fromInfo.line === toInfo.line) {
                // 【直通】同じ路線内
                duration = calculateLineDuration(fromInfo.data, fromInfo.index, toInfo.index);
                steps = [
                    { role: "【乗る場所】", name: from, type: "boarding-station" },
                    { role: "【降りる場所】", name: to, type: "alighting-station" }
                ];
            } else {
                // 【乗り換え】路線が違う、または経由指定あり
                // 接続駅の候補（中央駅、市駅、北駅、空港駅）
                const hubs = ["中央駅", "市駅", "北駅", "空港駅"];
                let bestHub = via || "";
                
                if (!bestHub) {
                    // 両方の路線に含まれる駅を探す
                    for (let h of hubs) {
                        if (fromInfo.data.stations.includes(h) && toInfo.data.stations.includes(h)) {
                            bestHub = h;
                            break;
                        }
                    }
                }
                
                if (!bestHub) bestHub = "中央駅"; // デフォルト

                const hIdx1 = fromInfo.data.stations.indexOf(bestHub);
                const hIdx2 = toInfo.data.stations.indexOf(bestHub);

                if (hIdx1 !== -1 && hIdx2 !== -1) {
                    const d1 = calculateLineDuration(fromInfo.data, fromInfo.index, hIdx1);
                    const d2 = calculateLineDuration(toInfo.data, toInfo.index, hIdx2);
                    duration = d1 + d2 + 5; // 乗り換え時間 5分
                    steps = [
                        { role: "【乗る場所】", name: from, type: "boarding-station" },
                        { role: "【経由場所】", name: bestHub, type: "via-station", sub: "乗換 5分" },
                        { role: "【降りる場所】", name: to, type: "alighting-station" }
                    ];
                }
            }
        }

        // 以下、計算不能な場合のフォールバック
        if (steps.length === 0) {
            duration = 30;
            steps = [{ role: "【乗る場所】", name: from, type: "boarding-station" }, { role: "【経由場所】", name: via || "中央駅", type: "via-station", sub: "乗換 5分" }, { role: "【降りる場所】", name: to, type: "alighting-station" }];
        }

        const calcTime = (h, m, offset) => {
            let tm = parseInt(h) * 60 + parseInt(m) + offset;
            if (tm < 0) tm += 24 * 60;
            return `${Math.floor((tm/60)%24).toString().padStart(2,'0')}:${(tm%60).toString().padStart(2,'0')}`;
        };

        let startTime, endTime;
        if (type === "始発") { startTime = "04:30"; endTime = calcTime(4, 30, duration); }
        else if (type === "終電") { startTime = "01:00"; endTime = calcTime(1, 0, duration); }
        else if (type === "到着") { endTime = inputT; startTime = calcTime(hs.value, ms.value, -duration); }
        else { startTime = inputT; endTime = calcTime(hs.value, ms.value, duration); }

        const fare = Math.floor(100 + (duration / 3) * 50);
        let stepsHtml = steps.map(s => `<div class="station-item ${s.type}"><span class="role-tag">${s.role}</span><span class="station-name-text">${s.name}</span><span class="time-info-text">${s.type === 'alighting-station' ? endTime + ' 着' : s.type === 'boarding-station' ? startTime + ' 発' : s.sub}</span></div>`).join('');

        document.getElementById('transferResults').innerHTML = `
            <div class="route-box">
                <div class="route-time-header"><span class="time-range-text">${startTime} 発 ～ ${endTime} 着</span></div>
                <div class="route-info">所要時間: ${duration}分 / 運賃: ${fare}円 / 条件: ${type}指定</div>
                <div class="vertical-station-list">${stepsHtml}</div>
                <div class="time-shift-buttons"><button class="btn-shift" onclick="shiftTime(-15)">1本前</button><button class="btn-shift" onclick="shiftTime(15)">1本後</button></div>
            </div>
        `;
    }
</script>
</body>
</html>
